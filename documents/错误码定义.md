# 错误码定义文档

## 错误码格式说明

错误码为字符串类型，共 5 位，分成两个部分：**错误产生来源 + 四位数字编号**

格式：`A-BB-CCC`
- **A** (1位): 错误来源 (Type/Source)
- **BB** (2位): 业务域/服务标识 (Domain)
- **CCC** (3位): 具体错误编号 (Case)

> **注意**：错误码不能直接输出给用户作为提示信息使用，需要转换为用户友好的提示信息。

---

## 第一段：错误来源 (Type/Source) - 1位（A）

**决定报警级别和处理策略**

| 代码 | 类型 | 定义 | 策略 | 处理方式 |
|------|------|------|------|----------|
| **A** / **1** | User Error | 用户端错误：用户发起的请求有问题，系统逻辑无误。如：参数必填项为空、格式错误、未登录、余额不足、版本过低。 | 不报警(仅在监控大盘展示趋势)，是正常业务逻辑的一部分 | 前端给用户友好提示 |
| **B** / **2** | System Error | 系统执行错误：用户请求正确，但系统内部崩了。如：NullPointException、数组越界、数据库死锁、连接池耗尽、配置加载失败 | **P0 / P1 级核心报警**。这意味着代码质量问题或基础设施故障，研发必须立即介入 | 触发报警，研发立即排查 |
| **C** / **3** | Third-party Error | 第三方调用错误：系统本身无误，依赖的下游（RPC服务）或外部API（如微信支付、阿里云短信）报错或超时 | **关注级报警**。通常结合熔断与降级机制处理。运维人员需确认是网络抖动还是服务商故障 | 触发钉钉报警，确认是否需要降级 |

---

## 第二段：业务域/服务标识（Domain） - 2位（BB）

由架构组统一分配，**映射具体的微服务或业务线**。快速定位问题出在哪个服务。

| 代码 | 业务域 | 说明 |
|------|--------|------|
| **00** | 通用/基础架构 | Gateway, Middleware, 通用工具类 |
| **01** | 用户中心 | User Service - 用户注册、登录、认证、个人信息管理 |
| **02** | 文章中心 | Article Service - 文章CRUD、点赞、收藏、浏览 |
| **03** | 评论中心 | Comments Service - 文章评论、回复 |
| **04** | 分类中心 | Category Service - 文章分类管理 |
| **05** | 标签中心 | Tags Service - 标签管理 |
| **06** | 友链中心 | Link Service - 友链管理 |
| **07** | 树洞评论中心 | TreeComments Service - 树洞评论管理 |

> 如果微服务超过99个，可扩展为3位，或改用16进制表示

---

## 第三段：具体错误编号（Case） - 3位（CCC）

自增数字，标识具体的业务场景。

**分层设计建议：**
- **001~099**：该服务内的通用错误（如：参数错误、格式错误）
- **100~199**：具体场景错误（如：用户中心-手机号注册-格式错误）

---

## 错误码列表

### 00 - 通用/基础架构

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A00001 | 参数验证失败 | 通用参数校验失败 | User Error |
| A00002 | 未授权 | 未授权访问 | User Error |
| B00001 | 系统内部错误 | 系统未知异常 | System Error |
| B00002 | 数据库连接失败 | 数据库连接异常 | System Error |
| B00003 | 配置加载失败 | 配置文件加载异常 | System Error |
| C00001 | 第三方服务调用失败 | 第三方服务异常 | Third-party Error |
| C00002 | 第三方服务超时 | 第三方服务响应超时 | Third-party Error |

---

### 01 - 用户中心

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A01001 | 当前邮箱还未注册 | 登录时邮箱不存在 | User Error |
| A01002 | 邮箱或密码错误 | 登录时密码错误 | User Error |
| A01003 | 用户未登录 | 需要登录才能访问 | User Error |
| A01004 | 当前邮箱已经注册过账号 | 注册时邮箱已存在 | User Error |
| A01005 | 当前用户已被拉入黑名单 | 用户状态异常 | User Error |
| A01006 | id_token不能为空 | Google登录token为空 | User Error |
| A01007 | 无效的audience | Google登录audience验证失败 | User Error |
| A01008 | 邮箱格式不正确 | 邮箱格式验证失败 | User Error |
| A01009 | 用户昵称不超过30个字符 | 用户名长度超限 | User Error |
| A01010 | 当前密码填写错误 | 修改密码时原密码错误 | User Error |
| A01011 | 新密码不能和当前密码相同 | 修改密码时新旧密码相同 | User Error |
| B01001 | ID Token 验证失败 | Google登录token验证异常 | System Error |
| B01002 | 无效的issuer | Google登录issuer验证失败 | System Error |
| C01001 | 从github获取access token失败 | GitHub OAuth失败 | Third-party Error |

---

### 02 - 文章中心

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A02001 | 不存在该文章 | 文章不存在 | User Error |
| A02002 | 文章内容不能为空 | 文章内容为空 | User Error |
| A02003 | 文章字数超出限制 | 文章内容超长 | User Error |
| A02004 | 登录之后才能收藏文章 | 未登录不能收藏 | User Error |

---

### 03 - 评论中心

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A03001 | 不存在该被回复者 | 回复的用户不存在 | User Error |

---

### 04 - 分类中心

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A04001 | 当前分类关联了文章，不能删除 | 分类被文章引用 | User Error |

---

### 05 - 标签中心

| 错误码 | 错误信息 | 说明 | 类型 |
|--------|----------|------|------|
| A05001 | 当前标签关联了文章，不能删除 | 标签被文章引用 | User Error |

---

## 错误码使用示例

### 示例 1：用户端错误
```
错误码：A01001
来源：A (用户端错误)
业务域：01 (用户中心)
错误编号：001 (当前邮箱还未注册)
结果：前端弹窗提示"当前邮箱还未注册"，无需后端排查
```

### 示例 2：系统错误
```
错误码：B01001
来源：B (系统错误)
业务域：01 (用户中心)
错误编号：001 (ID Token 验证失败)
结果：触发电话报警给用户组研发，立即查看日志
```

### 示例 3：第三方错误
```
错误码：C01001
来源：C (第三方错误)
业务域：01 (用户中心)
错误编号：001 (从github获取access token失败)
结果：触发钉钉报警，确认是否需要降级或切换认证方式
```

---

## 错误码使用规范

1. **错误码定义**：所有错误码必须在此文档中定义，新增错误码需要经过评审
2. **错误码使用**：使用 `BaseException` 抛出业务异常，传入错误码和错误信息
3. **错误信息**：错误信息应该对用户友好，不能暴露系统内部细节
4. **错误码映射**：前端根据错误码显示对应的用户友好提示
5. **日志记录**：所有错误都需要记录日志，包含错误码、错误信息、请求ID等

---

## 扩展说明

- 当业务域超过99个时，可扩展为3位（如：001、002...）
- 错误编号可以按功能模块分段，便于管理和查找
- 建议定期审查错误码使用情况，合并重复的错误码

