import{_ as b,r as d,i as U,e as z,j as L,c,o as m,B as g,b as r,a as k,h as f,y as T,ae as V,z as E,af as K,D as y,w as x,f as H,J as M,E as t,ag as N,a7 as $}from"./index-CxeTFetW.js";import{_ as A}from"./Galaxy.vue_vue_type_script_setup_true_lang-DrxMH1_0.js";import{_ as F}from"./_plugin-vue_export-helper-DlAUqK2U.js";const j="/assets/sunrise-6F-K_2mG.mp4",D={getTreeHoleList(){return b({url:"/user/tree/list",method:"get",isPublicResource:!0})},addTreeHole(p){return b({url:"/user/tree",method:"post",data:p})}};function q(){return D.getTreeHoleList()}function G(p){return D.addTreeHole(p)}const J={key:0,class:"background-wrapper"},P={key:1,class:"background-wrapper"},O={class:"content_container",style:{"margin-top":"45px"}},Q={class:"input_wrapper"},W=["disabled"],X=["disabled"],Y={key:0,class:"char-count"},Z={class:"barrage_container"},ee={class:"nickname"},se={class:"content"},te={key:2,class:"loading_mask"},ne={__name:"index",setup(p){const h=d([]),v=d(!1),a=d(""),l=d(!1),n=U(),_=z(),S=d(null),B=d(null);function C(o){return o?`https://ui-avatars.com/api/?name=${encodeURIComponent(o)}&background=random&size=40`:"https://ui-avatars.com/api/?name=匿名&background=random&size=40"}async function w(){try{l.value=!0;const o=await q();o.code===200?h.value=(o.data||[]).map(e=>{const i=e.username||"匿名用户";return{id:e.id||e.user_id,nickname:i,avatar:e.avatar||C(i),content:e.content,createTime:e.create_time}}):t.error(o.msg||"获取数据失败")}catch(o){console.error("获取树洞列表失败:",o),t.error("获取数据失败，请稍后重试")}finally{l.value=!1}}function R(){setTimeout(()=>{a.value===""&&(v.value=!1)},200)}async function I(){if(!a.value||a.value.trim()===""){t.warning("请输入内容");return}if(a.value.trim().length>50){t.warning("内容不能超过50个字符");return}if(!N()){t.warning("请先登录后再发表弹幕");return}let e=null,i="";if(n.userInfo)e=n.userInfo.id||n.userInfo.userId,i=n.userInfo.username||n.userInfo.nickname||"";else try{await n.getUserInfo(),n.userInfo&&(e=n.userInfo.id||n.userInfo.userId,i=n.userInfo.username||n.userInfo.nickname||"")}catch(s){console.error("获取用户信息失败:",s)}if(!e){t.error("无法获取用户信息，请重新登录");return}i||(i="匿名用户");try{l.value=!0;const s=await G({userId:e,username:i,content:a.value.trim()});s.code===200?(t.success(s.msg||"发表成功"),a.value="",v.value=!1,await w()):t.error(s.msg||"发表失败")}catch(s){if(console.error("发表弹幕失败:",s),s.response){const u=s.response.status;u===401?t.error("登录已过期，请重新登录"):u===403?t.error("没有权限发表弹幕"):t.error(s.response.data?.msg||"发表失败，请稍后重试")}else t.error("发表失败，请稍后重试")}finally{l.value=!1}}return L(()=>{w()}),(o,e)=>{const i=H("vue-danmaku"),s=H("el-icon");return m(),c("div",{class:M(["container",{"dark-mode":f(_).isDark,"light-mode":!f(_).isDark}])},[f(_).isDark?(m(),c("div",J,[k(A,{focal:[.5,.5],rotation:[1,0],"star-speed":.3,density:1.2,"hue-shift":240,speed:.8,"mouse-interaction":!0,"glow-intensity":.4,saturation:.2,"mouse-repulsion":!0,"twinkle-intensity":.3,"rotation-speed":.05,"repulsion-strength":3,"auto-center-repulsion":.5,transparent:!0})])):g("",!0),f(_).isDark?g("",!0):(m(),c("div",P,[r("video",{ref_key:"videoRef",ref:S,class:"video-background",autoplay:"",loop:"",muted:"",playsinline:""},[...e[3]||(e[3]=[r("source",{src:j,type:"video/mp4"},null,-1)])],512)])),r("div",O,[e[5]||(e[5]=r("div",{class:"title"},"树洞",-1)),r("div",Q,[T(r("input",{"onUpdate:modelValue":e[0]||(e[0]=u=>a.value=u),onFocus:e[1]||(e[1]=u=>v.value=!0),onBlur:R,type:"text",placeholder:"在这里留下自己的足迹吧...",maxlength:"50",disabled:l.value,onKeyup:E(I,["enter"])},null,40,W),[[V,a.value]]),T(r("button",{onClick:I,disabled:l.value},[...e[4]||(e[4]=[r("span",{class:"submit-text"},"发送",-1)])],8,X),[[K,v.value]])]),a.value.length>0?(m(),c("div",Y,y(a.value.length)+"/50 ",1)):g("",!0)]),k(i,{ref_key:"danmakuRef",ref:B,debounce:3e3,"random-channel":"",speeds:80,channels:5,"is-suspend":"",autoplay:!0,danmus:h.value,"onUpdate:danmus":e[2]||(e[2]=u=>h.value=u),"use-slot":"",loop:"",style:{height:"calc(100vh - 70px)",width:"100vw"}},{dm:x(({danmu:u})=>[r("div",Z,[r("span",ee,y(u.nickname)+"：",1),r("span",se,y(u.content),1)])]),_:1},8,["danmus"]),l.value?(m(),c("div",te,[k(s,{class:"is-loading"},{default:x(()=>[k(f($))]),_:1})])):g("",!0)],2)}}},ie=F(ne,[["__scopeId","data-v-6755e137"]]);export{ie as default};
