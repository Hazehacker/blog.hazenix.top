import{a2 as A,r as o,i as j,f as Q,k as E,l as W,A as X,c as k,o as g,J as D,b as v,g as Y,h as y,a as R,B as K,ac as Z,H as ee,E as te,t as S,w as V,d as z,M as ne,K as r,ad as ae,a3 as se,O as le}from"./index-Cr_Or7lo.js";import{_ as oe}from"./Galaxy.vue_vue_type_script_setup_true_lang-D3SdqEUq.js";import{_ as re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue="/assets/sunrise-6F-K_2mG.mp4",N={getTreeHoleList(){return A({url:"/user/tree/list",method:"get",isPublicResource:!0})},addTreeHole(w){return A({url:"/user/tree",method:"post",data:w})}};function ie(){return N.getTreeHoleList()}function ce(w){return N.addTreeHole(w)}const ve={key:0,class:"background-wrapper"},de={key:1,class:"background-wrapper"},fe={class:"content_container",style:{"margin-top":"45px"}},me={class:"input_wrapper"},pe=["disabled"],ge=["disabled"],he={key:0,class:"char-count"},_e={class:"barrage_container"},ke={class:"nickname"},ye={class:"content"},we={key:2,class:"loading_mask"},Ie={__name:"index",setup(w){const d=o([]),s=o([]),I=o(!1),f=o(""),m=o(!1),p=o(!1),T=o(null),x=o(0),u=o(null),B=o(0),h=o(!1),L=o(0),i=j(),b=Q(),q=o(null),c=o(null);function F(n){return n?`https://ui-avatars.com/api/?name=${encodeURIComponent(n)}&background=random&size=40`:"https://ui-avatars.com/api/?name=匿名&background=random&size=40"}async function $(){try{m.value=!0;const n=await ie();if(n.code===200){const e=(n.data||[]).map(t=>{const a=t.username||"匿名用户";return{id:t.id||t.user_id,nickname:a,avatar:t.avatar||F(a),content:t.content,createTime:t.create_time}});d.value=e,s.value.length===0&&(s.value=e.map(t=>({...t,_refreshTime:Date.now()})))}else r.error(n.msg||"获取数据失败")}catch(n){console.error("获取树洞列表失败:",n),r.error("获取数据失败，请稍后重试")}finally{m.value=!1}}function G(){if(!c.value)return 0;try{const n=c.value.$el||c.value;if(!n)return 0;const e=[".barrage_container",'[class*="danmu"]','[class*="barrage"]','div[style*="position"]'];let t=0;for(const a of e){const l=n.querySelectorAll(a);if(l.length>0){const O=Array.from(l).filter(P=>{const U=P.getBoundingClientRect();return U.width>0&&U.height>0});t=Math.max(t,O.length)}}return t}catch(n){return console.warn("检查弹幕元素时出错:",n),0}}function C(){p.value||d.value.length===0||(p.value=!0,s.value=[],setTimeout(()=>{L.value=Date.now();const n=Date.now(),e=d.value.map((t,a)=>({...t,id:`${t.id}_${n}_${a}`,_refreshTime:n}));le(()=>{s.value=e,x.value=s.value.length,u.value=null,B.value=Date.now(),setTimeout(()=>{if(c.value)try{typeof c.value.play=="function"&&c.value.play(),typeof c.value.start=="function"&&c.value.start(),typeof c.value.resume=="function"&&c.value.resume()}catch(t){console.warn("启动弹幕播放失败:",t)}p.value=!1,console.log("弹幕已重新填充，数量:",s.value.length)},300)})},200))}function _(){T.value&&(clearInterval(T.value),T.value=null),h.value=!1}function H(){h.value&&_(),d.value.length!==0&&(h.value=!0,x.value=s.value.length,u.value=null,T.value=setInterval(()=>{if(p.value)return;const n=s.value.length,e=G(),t=Date.now();if(n===0&&d.value.length>0){console.log("弹幕列表为空，立即重新填充"),u.value=null,_(),C(),setTimeout(()=>{H()},2e3);return}const a=t-B.value;if(e<=1&&n>0&&a>=5e3){if(u.value===null)u.value=t,console.log("弹幕数量降到很低，开始计时。屏幕弹幕数:",e,"数组长度:",n,"距离上次填充:",Math.round(a/1e3)+"秒");else if(t-u.value>=5e3){console.log("弹幕数量持续很低超过5秒，重新填充。屏幕弹幕数:",e,"数组长度:",n),u.value=null,_(),C(),setTimeout(()=>{H()},5e3);return}}else e>1&&(u.value!==null&&console.log("弹幕数量增加，重置计时。屏幕弹幕数:",e),u.value=null),a<5e3&&(u.value=null);x.value=n},1e3))}E(()=>s.value.length,(n,e)=>{e>0&&n===0&&d.value.length>0&&!p.value&&(console.log("弹幕列表变为空，立即重新填充"),C())}),E(()=>d.value.length,n=>{n>0?h.value||setTimeout(()=>{!h.value&&d.value.length>0&&H()},100):_()},{immediate:!0});function J(){setTimeout(()=>{f.value===""&&(I.value=!1)},200)}async function M(){if(!f.value||f.value.trim()===""){r.warning("请输入内容");return}if(f.value.trim().length>50){r.warning("内容不能超过50个字符");return}if(!ae()){r.warning("请先登录后再发表弹幕");return}let e=null,t="";if(i.userInfo)e=i.userInfo.id||i.userInfo.userId,t=i.userInfo.username||i.userInfo.nickname||"";else try{await i.getUserInfo(),i.userInfo&&(e=i.userInfo.id||i.userInfo.userId,t=i.userInfo.username||i.userInfo.nickname||"")}catch(a){console.error("获取用户信息失败:",a)}if(!e){r.error("无法获取用户信息，请重新登录");return}t||(t="匿名用户");try{m.value=!0;const a=await ce({userId:e,username:t,content:f.value.trim()});a.code===200?(r.success(a.msg||"发表成功"),f.value="",I.value=!1,await $(),s.value.length===0&&d.value.length>0?s.value=[...d.value]:s.value.length>0):r.error(a.msg||"发表失败")}catch(a){if(console.error("发表弹幕失败:",a),a.response){const l=a.response.status;l===401?r.error("登录已过期，请重新登录"):l===403?r.error("没有权限发表弹幕"):r.error(a.response.data?.msg||"发表失败，请稍后重试")}else r.error("发表失败，请稍后重试")}finally{m.value=!1}}return W(()=>{$()}),X(()=>{_(),p.value=!1,u.value=null}),(n,e)=>{const t=z("vue-danmaku"),a=z("el-icon");return g(),k("div",{class:ne(["container",{"dark-mode":y(b).isDark,"light-mode":!y(b).isDark}])},[y(b).isDark?(g(),k("div",ve,[R(oe,{focal:[.5,.5],rotation:[1,0],"star-speed":.3,density:1.2,"hue-shift":240,speed:.8,"mouse-interaction":!0,"glow-intensity":.4,saturation:.2,"mouse-repulsion":!0,"twinkle-intensity":.3,"rotation-speed":.05,"repulsion-strength":3,"auto-center-repulsion":.5,transparent:!0})])):D("",!0),y(b).isDark?D("",!0):(g(),k("div",de,[v("video",{ref_key:"videoRef",ref:q,class:"video-background",autoplay:"",loop:"",muted:"",playsinline:""},[...e[3]||(e[3]=[v("source",{src:ue,type:"video/mp4"},null,-1)])],512)])),v("div",fe,[e[5]||(e[5]=v("div",{class:"title"},"树洞",-1)),v("div",me,[K(v("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>f.value=l),onFocus:e[1]||(e[1]=l=>I.value=!0),onBlur:J,type:"text",placeholder:"在这里留下自己的足迹吧...",maxlength:"50",disabled:m.value,onKeyup:ee(M,["enter"])},null,40,pe),[[Z,f.value]]),K(v("button",{onClick:M,disabled:m.value},[...e[4]||(e[4]=[v("span",{class:"submit-text"},"发送",-1)])],8,ge),[[te,I.value]])]),f.value.length>0?(g(),k("div",he,S(f.value.length)+"/50 ",1)):D("",!0)]),(g(),Y(t,{ref_key:"danmakuRef",ref:c,key:L.value,debounce:3e3,"random-channel":"",speeds:80,channels:5,"is-suspend":"",autoplay:!0,danmus:s.value,"onUpdate:danmus":e[2]||(e[2]=l=>s.value=l),"use-slot":"",style:{height:"calc(100vh - 70px)",width:"100vw"}},{dm:V(({danmu:l})=>[v("div",_e,[v("span",ke,S(l.nickname)+"：",1),v("span",ye,S(l.content),1)])]),_:1},8,["danmus"])),m.value?(g(),k("div",we,[R(a,{class:"is-loading"},{default:V(()=>[R(y(se))]),_:1})])):D("",!0)],2)}}},xe=re(Ie,[["__scopeId","data-v-29307f9b"]]);export{xe as default};
